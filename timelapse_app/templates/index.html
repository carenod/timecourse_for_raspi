<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raspberry Pi Timelapse Controller</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.18);
            margin-bottom: 20px;
            padding: 25px;
        }
        
        .system-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .info-item {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .info-item.good {
            border-color: #28a745;
        }
        
        .info-item.warning {
            border-color: #ffc107;
        }
        
        .info-item.danger {
            border-color: #dc3545;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }
        
        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .input-group {
            display: flex;
            gap: 10px;
        }
        
        .input-group input {
            flex: 2;
        }
        
        .input-group select {
            flex: 1;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            margin: 5px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a5a 100%);
            color: white;
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(238, 90, 90, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #51cf66 0%, #40c057 100%);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(64, 192, 87, 0.4);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }
        
        .status-section {
            display: none;
        }
        
        .status-section.active {
            display: block;
        }
        
        .progress-bar {
            background: #e9ecef;
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            background: linear-gradient(135deg, #51cf66 0%, #40c057 100%);
            height: 100%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }
        
        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .project-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }
        
        .project-item:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid;
        }
        
        .alert-success {
            background-color: #d1ecf1;
            border-color: #28a745;
            color: #0c5460;
        }
        
        .alert-error {
            background-color: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .tab {
            padding: 15px 25px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .system-info {
                grid-template-columns: 1fr;
            }
            
            .projects-grid {
                grid-template-columns: 1fr;
            }
            
            .input-group {
                flex-direction: column;
            }
            
            .input-group input,
            .input-group select {
                flex: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé• Raspberry Pi Timelapse Controller</h1>
            <p>Create amazing timelapses with your Raspberry Pi camera</p>
        </div>

        <!-- System Information -->
        <div class="card">
            <h2>üìä System Status</h2>
            <div class="system-info" id="systemInfo">
                <div class="info-item" id="cameraStatus">
                    <h3>üì∑ Camera</h3>
                    <p>Checking...</p>
                </div>
                <div class="info-item" id="diskSpace">
                    <h3>üíæ Disk Space</h3>
                    <p>Loading...</p>
                </div>
                <div class="info-item" id="usbDevices">
                    <h3>üîå USB Devices</h3>
                    <p>Scanning...</p>
                </div>
                <div class="info-item" id="currentTime">
                    <h3>‚è∞ Current Time</h3>
                    <p>Loading...</p>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('control')">üé¨ Control</button>
            <button class="tab" onclick="showTab('projects')">üìÅ Projects</button>
        </div>

        <!-- Control Tab -->
        <div id="controlTab" class="tab-content active">
            <!-- Timelapse Setup -->
            <div class="card" id="setupSection">
                <h2>üé¨ New Timelapse</h2>
                <form id="timelapseForm" onsubmit="startTimelapse(event)">
                    <div class="form-group">
                        <label for="projectName">Project Name:</label>
                        <input type="text" id="projectName" name="name" required 
                               placeholder="e.g., Arabidopsis_2025">
                    </div>
                    
                    <div class="form-group">
                        <label for="interval">Interval:</label>
                        <div class="input-group">
                            <input type="number" id="intervalValue" name="interval_value" 
                                   min="0.01" step="0.01" value="60" required>
                            <select id="intervalUnit" name="interval_unit" required>
                                <option value="seconds">Seconds</option>
                                <option value="minutes" selected>Minutes</option>
                                <option value="hours">Hours</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="duration">Duration:</label>
                        <div class="input-group">
                            <input type="number" id="durationValue" name="duration_value" 
                                   min="0.01" step="0.01" value="10" required>
                            <select id="durationUnit" name="duration_unit" required>
                                <option value="minutes">Minutes</option>
                                <option value="hours">Hours</option>
                                <option value="days" selected>Days</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="resolution">Resolution:</label>
                        <select id="resolution" name="resolution" required>
                            <option value="1920x1080">1920x1080 (Full HD)</option>
                            <option value="1280x720">1280x720 (HD)</option>
                            <option value="2592x1944">2592x1944 (Pi Camera Max)</option>
                            <option value="640x480">640x480 (VGA)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="quality">JPEG Quality (1-100):</label>
                        <input type="number" id="quality" name="quality" 
                               min="1" max="100" value="100" required>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">üöÄ Start Timelapse</button>
                </form>
            </div>

            <!-- Timelapse Status -->
            <div class="card status-section" id="statusSection">
                <h2>üìä Timelapse Status</h2>
                <div id="statusInfo">
                    <p><strong>Project:</strong> <span id="currentProject">-</span></p>
                    <p><strong>Status:</strong> <span id="currentStatus">-</span></p>
                    <p><strong>Images Captured:</strong> <span id="imagesCaptured">0</span> / <span id="totalImages">0</span></p>
                    <p><strong>Progress:</strong></p>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                    <p><strong>Folder Size:</strong> <span id="folderSize">0 B</span></p>
                    <p><strong>Started:</strong> <span id="startTime">-</span></p>
                    <p><strong>Estimated End:</strong> <span id="endTime">-</span></p>
                </div>
                <div style="margin-top: 20px;">
                    <button id="stopBtn" class="btn btn-danger" onclick="stopTimelapse()">‚èπ Stop Timelapse</button>
                </div>
            </div>
        </div>

        <!-- Projects Tab -->
        <div id="projectsTab" class="tab-content">
            <div class="card">
                <h2>üìÅ My Projects</h2>
                <button onclick="loadProjects()" class="btn btn-primary">üîÑ Refresh</button>
                <div class="projects-grid" id="projectsList">
                    <!-- Projects will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Alerts -->
        <div id="alerts"></div>
    </div>

    <script>
        let statusInterval;
        let systemInfoInterval;
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, initializing...');
            loadSystemInfo();
            loadProjects();
            checkCurrentStatus();
            
            // Update system info every 30 seconds
            systemInfoInterval = setInterval(loadSystemInfo, 30000);
        });
        
        function showTab(tabName) {
            console.log('Switching to tab:', tabName);
            
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
            
            // Load projects when switching to projects tab
            if (tabName === 'projects') {
                loadProjects();
            }
        }
        
        function loadSystemInfo() {
            console.log('Loading system info...');
            fetch('/api/system_info')
                .then(response => {
                    console.log('System info response:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('System info data:', data);
                    
                    // Camera status
                    const cameraEl = document.getElementById('cameraStatus');
                    cameraEl.querySelector('p').textContent = data.camera_available ? 'Available' : 'Not Available';
                    cameraEl.className = `info-item ${data.camera_available ? 'good' : 'danger'}`;
                    
                    // Disk space
                    const diskEl = document.getElementById('diskSpace');
                    diskEl.querySelector('p').textContent = `${data.disk_free_gb}GB free of ${data.disk_total_gb}GB`;
                    const diskClass = data.disk_used_percent > 90 ? 'danger' : data.disk_used_percent > 80 ? 'warning' : 'good';
                    diskEl.className = `info-item ${diskClass}`;
                    
                    // USB devices
                    const usbEl = document.getElementById('usbDevices');
                    usbEl.querySelector('p').textContent = data.usb_devices.length > 0 ? 
                        data.usb_devices.join(', ') : 'None detected';
                    usbEl.className = `info-item ${data.usb_devices.length > 0 ? 'good' : 'warning'}`;
                    
                    // Current time
                    const timeEl = document.getElementById('currentTime');
                    const time = new Date(data.current_time).toLocaleString();
                    timeEl.querySelector('p').textContent = time;
                })
                .catch(error => {
                    console.error('Failed to load system info:', error);
                    showAlert('Failed to load system information', 'error');
                });
        }
        
        function startTimelapse(event) {
            event.preventDefault();
            console.log('Starting timelapse...');
            
            const formData = new FormData(document.getElementById('timelapseForm'));
            const data = Object.fromEntries(formData);
            console.log('Form data:', data);
            
            fetch('/api/start_timelapse', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                console.log('Start timelapse response:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Start timelapse data:', data);
                if (data.error) {
                    showAlert(data.error, 'error');
                } else {
                    showAlert('Timelapse started successfully!', 'success');
                    document.getElementById('setupSection').style.display = 'none';
                    document.getElementById('statusSection').classList.add('active');
                    startStatusUpdates();
                }
            })
            .catch(error => {
                console.error('Error starting timelapse:', error);
                showAlert('Failed to start timelapse', 'error');
            });
        }
        
        function stopTimelapse() {
            console.log('Stopping timelapse...');
            fetch('/api/stop_timelapse', {
                method: 'POST'
            })
            .then(response => {
                console.log('Stop timelapse response:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Stop timelapse data:', data);
                if (data.error) {
                    showAlert(data.error, 'error');
                } else {
                    showAlert('Timelapse stopped', 'success');
                    stopStatusUpdates();
                    document.getElementById('setupSection').style.display = 'block';
                    document.getElementById('statusSection').classList.remove('active');
                }
            })
            .catch(error => {
                console.error('Error stopping timelapse:', error);
                showAlert('Failed to stop timelapse', 'error');
            });
        }
        
        function startStatusUpdates() {
            console.log('Starting status updates...');
            statusInterval = setInterval(updateStatus, 2000); // Update every 2 seconds
            updateStatus(); // Initial update
        }
        
        function stopStatusUpdates() {
            console.log('Stopping status updates...');
            if (statusInterval) {
                clearInterval(statusInterval);
                statusInterval = null;
            }
        }
        
        function checkCurrentStatus() {
            console.log('Checking current status...');
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    console.log('Current status:', data);
                    if (data.status && data.status !== 'idle') {
                        document.getElementById('setupSection').style.display = 'none';
                        document.getElementById('statusSection').classList.add('active');
                        startStatusUpdates();
                    }
                })
                .catch(error => {
                    console.error('Failed to check current status:', error);
                });
        }
        
        function updateStatus() {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'idle') {
                        stopStatusUpdates();
                        document.getElementById('setupSection').style.display = 'block';
                        document.getElementById('statusSection').classList.remove('active');
                        return;
                    }
                    
                    document.getElementById('currentProject').textContent = data.name || '-';
                    document.getElementById('currentStatus').textContent = data.status || '-';
                    document.getElementById('imagesCaptured').textContent = data.images_captured || 0;
                    document.getElementById('totalImages').textContent = data.total_images || 0;
                    document.getElementById('folderSize').textContent = data.folder_size || '0 B';
                    
                    const progress = data.progress || 0;
                    document.getElementById('progressFill').style.width = progress + '%';
                    
                    if (data.start_time) {
                        document.getElementById('startTime').textContent = new Date(data.start_time).toLocaleString();
                    }
                    if (data.end_time) {
                        document.getElementById('endTime').textContent = new Date(data.end_time).toLocaleString();
                    }
                    
                    // If completed or stopped, stop updates
                    if (data.status === 'completed' || data.status === 'stopped') {
                        stopStatusUpdates();
                        showAlert(`Timelapse ${data.status}!`, 'success');
                        setTimeout(() => {
                            document.getElementById('setupSection').style.display = 'block';
                            document.getElementById('statusSection').classList.remove('active');
                        }, 3000);
                    }
                })
                .catch(error => {
                    console.error('Failed to update status:', error);
                });
        }
        
        function loadProjects() {
            console.log('Loading projects...');
            fetch('/api/projects')
                .then(response => {
                    console.log('Projects response:', response.status);
                    return response.json();
                })
                .then(projects => {
                    console.log('Projects data:', projects);
                    const projectsList = document.getElementById('projectsList');
                    projectsList.innerHTML = '';
                    
                    if (projects.length === 0) {
                        projectsList.innerHTML = '<p style="text-align: center; padding: 20px;">No projects found. Create your first timelapse!</p>';
                        return;
                    }
                    
                    projects.forEach(project => {
                        const projectDiv = document.createElement('div');
                        projectDiv.className = 'project-item';
                        projectDiv.innerHTML = `
                            <h3>${project.name}</h3>
                            <p><strong>Images:</strong> ${project.file_count}</p>
                            <div style="margin-top: 15px;">
                                <a href="/api/download/${project.name}" class="btn btn-primary">üì• Download ZIP</a>
                                <button onclick="transferToUSB('${project.name}')" class="btn btn-success">üíæ Transfer to USB</button>
                                <button onclick="deleteProject('${project.name}')" class="btn btn-danger">üóëÔ∏è Delete</button>
                            </div>
                        `;
                        projectsList.appendChild(projectDiv);
                    });
                })
                .catch(error => {
                    console.error('Failed to load projects:', error);
                    showAlert('Failed to load projects', 'error');
                });
        }
        
        function transferToUSB(projectName) {
            console.log('Transferring project to USB:', projectName);
            // Get available USB devices
            fetch('/api/system_info')
                .then(response => response.json())
                .then(data => {
                    if (data.usb_devices.length === 0) {
                        showAlert('No USB devices detected', 'error');
                        return;
                    }
                    
                    let usbDevice;
                    if (data.usb_devices.length === 1) {
                        usbDevice = data.usb_devices[0];
                    } else {
                        usbDevice = prompt(`Select USB device:\n${data.usb_devices.join('\n')}\n\nEnter device name:`);
                        if (!usbDevice || !data.usb_devices.includes(usbDevice)) {
                            showAlert('Invalid USB device selected', 'error');
                            return;
                        }
                    }
                    
                    // Transfer to selected USB device
                    fetch(`/api/transfer_usb/${projectName}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ usb_device: usbDevice })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            showAlert(data.error, 'error');
                        } else {
                            showAlert(data.message, 'success');
                        }
                    })
                    .catch(error => {
                        console.error('Transfer failed:', error);
                        showAlert('Transfer failed', 'error');
                    });
                });
        }
        
        function deleteProject(projectName) {
            console.log('Deleting project:', projectName);
            if (confirm(`Are you sure you want to delete project "${projectName}"? This cannot be undone.`)) {
                fetch(`/api/delete_project/${projectName}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showAlert(data.error, 'error');
                    } else {
                        showAlert(data.message, 'success');
                        loadProjects(); // Refresh the list
                    }
                })
                .catch(error => {
                    console.error('Delete failed:', error);
                    showAlert('Delete failed', 'error');
                });
            }
        }
        
        function showAlert(message, type) {
            console.log('Showing alert:', message, type);
            const alertsDiv = document.getElementById('alerts');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type === 'error' ? 'error' : 'success'}`;
            alertDiv.textContent = message;
            
            alertsDiv.appendChild(alertDiv);
            
            // Remove alert after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 5000);
        }
    </script>
</body>
</html>